# ---------------------------------------------------------------
# CI — Run on feature / dev branches (not main)
# Stamps the patch version with the build number for traceability.
# ---------------------------------------------------------------
name: CI

on:
  workflow_dispatch:  # Manual only — automatic triggers disabled
  # push:
  #   branches-ignore: [main]
  # pull_request:
  #   branches-ignore: [main]

permissions:
  contents: read

jobs:
  version:
    name: Stamp build version
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.ver.outputs.version }}
    steps:
      - uses: actions/checkout@v4

      - name: Compute CI version
        id: ver
        run: |
          # Read base version from setup.py (e.g. 0.1.0)
          BASE=$(python -c "import re, pathlib; m=re.search(r'VERSION\s*=\s*\"(.+?)\"', pathlib.Path('setup.py').read_text()); print(m.group(1))")
          # Replace patch with the GitHub run number → 0.1.<run>
          MAJOR_MINOR=$(echo "$BASE" | sed -E 's/([0-9]+\.[0-9]+)\..*/\1/')
          CI_VERSION="${MAJOR_MINOR}.${{ github.run_number }}"
          echo "version=$CI_VERSION" >> "$GITHUB_OUTPUT"
          echo "CI version: $CI_VERSION"

  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install flake8 black isort

      - name: Run flake8
        run: flake8 azext_prototype/ --max-line-length=120 --extend-ignore=E203,W503

      - name: Check formatting (black)
        run: black --check --line-length 120 azext_prototype/

      - name: Check imports (isort)
        run: isort --check-only --profile black azext_prototype/

  validate-policies:
    name: Validate governance policies
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyyaml

      - name: Validate policy files (strict)
        run: python -m azext_prototype.governance.policies.validate --dir azext_prototype/governance/policies/ --strict

      - name: Validate workload templates against policies (strict)
        run: python -m azext_prototype.templates.validate --dir azext_prototype/templates/workloads/ --strict

  test:
    name: Test (Python ${{ matrix.python-version }})
    needs: version
    runs-on: ubuntu-latest
    env:
      APPINSIGHTS_CONNECTION_STRING: ${{ secrets.APPINSIGHTS_CONNECTION_STRING }}
    strategy:
      fail-fast: false
      matrix:
        python-version: ["3.10", "3.11", "3.12"]

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Stamp version into source
        run: |
          CI_VERSION="${{ needs.version.outputs.version }}"
          sed -i "s/^VERSION = \".*\"/VERSION = \"$CI_VERSION\"/" setup.py
          python -c "
          import json, pathlib
          p = pathlib.Path('azext_prototype/azext_metadata.json')
          d = json.loads(p.read_text())
          d['version'] = '$CI_VERSION'
          p.write_text(json.dumps(d, indent=2) + '\n')
          "
          echo "Stamped version: $CI_VERSION"

      - name: Inject App Insights connection string
        if: env.APPINSIGHTS_CONNECTION_STRING != ''
        run: |
          sed -i "s|^_BUILTIN_CONNECTION_STRING = \"\"$|_BUILTIN_CONNECTION_STRING = \"$APPINSIGHTS_CONNECTION_STRING\"|" azext_prototype/telemetry/__init__.py
          grep -q "$APPINSIGHTS_CONNECTION_STRING" azext_prototype/telemetry/__init__.py && echo "App Insights connection string injected" || { echo "::error::Failed to inject connection string"; exit 1; }

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          pip install pytest pytest-cov opencensus-ext-azure

      - name: Run tests
        run: pytest tests/ -v --tb=short --cov=azext_prototype --cov-report=xml --cov-report=term-missing

      - name: Upload coverage
        if: matrix.python-version == '3.11'
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report
          path: coverage.xml

  security:
    name: Security scan
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install bandit safety

      - name: Run bandit (security linter)
        run: bandit -r azext_prototype/ -ll --skip B101

      - name: Check dependencies for known vulnerabilities
        run: pip install -e . && safety check --output text
        continue-on-error: true  # Advisory — don't fail the build
